<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b8f3a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Snake (PWA, Offline)</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background:#111; color:#fff;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    header {
      text-align:center; padding: 10px 12px; background:#0b8f3a; color:#fff; font-weight:600;
      position: sticky; top: 0; z-index: 2;
    }
    main { display:flex; align-items:center; justify-content:center; height: calc(100% - 120px); }
    #game {
      background:#000; border: 2px solid #0b8f3a; border-radius:12px; box-sizing: content-box;
      touch-action: none;
    }
    .hud { text-align:center; padding:10px 0 4px; }
    .controls {
      display:flex; align-items:center; justify-content:center; gap:10px; margin: 8px 0 18px;
      user-select:none; -webkit-user-select:none;
    }
    .btn {
      background:#222; color:#9df2b9; border:1px solid #0b8f3a; border-radius:10px; padding:12px 15px;
      min-width:60px; text-align:center; font-size:16px;
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset, 0 2px 6px rgba(0,0,0,.35);
    }
    .btn:active { transform: translateY(1px); }
    footer { text-align:center; color:#bbb; font-size:12px; padding-bottom: 8px;}
    .install-hint { font-size: 12px; color:#9df2b9; }
  </style>
</head>
<body>
  <header>Snake — Offline PWA</header>
  <div class="hud">
    <div>Score: <span id="score">0</span> &nbsp;•&nbsp; Best: <span id="best">0</span></div>
  </div>
  <main>
    <canvas id="game" width="360" height="360" aria-label="Snake game canvas" role="img"></canvas>
  </main>
  <div class="controls" aria-label="Touch controls">
    <div class="btn" id="up">↑</div>
  </div>
  <div class="controls">
    <div class="btn" id="left">←</div>
    <div class="btn" id="down">↓</div>
    <div class="btn" id="right">→</div>
  </div>
  <footer>
    <div class="install-hint">Tip: In Safari, tap <strong>Share</strong> → <strong>Add to Home Screen</strong> to install.</div>
  </footer>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const grid = 18; // size of each cell
    const tileCount = canvas.width / grid;

    // Game state
    let snake = [{x: 9, y: 9}];
    let dir = {x: 1, y: 0};
    let pendingDir = dir;
    let apple = spawnApple();
    let score = 0;
    let best = Number(localStorage.getItem('snake-best') || 0);
    document.getElementById('best').textContent = best;

    function spawnApple() {
      while (true) {
        const a = { x: Math.floor(Math.random()*tileCount), y: Math.floor(Math.random()*tileCount) };
        if (!snake.some(s => s.x===a.x && s.y===a.y)) return a;
      }
    }

    function drawCell(x, y, fill='#2bdc75') {
      ctx.fillStyle = fill;
      ctx.fillRect(x*grid+1, y*grid+1, grid-2, grid-2);
    }

    function loop() {
      requestAnimationFrame(loop);
      if (!step()) return;
      render();
    }

    let last = 0, speedMs = 120;
    function step(ts) {
      if (!last) last = ts || 0;
      const now = ts || performance.now();
      if (now - last < speedMs) return false;
      last = now;

      // commit pending direction (prevents reversing into itself)
      dir = pendingDir;

      const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
      // wrap around edges
      head.x = (head.x + tileCount) % tileCount;
      head.y = (head.y + tileCount) % tileCount;

      // collision with body?
      if (snake.some((s,i) => i && s.x===head.x && s.y===head.y)) {
        reset();
        return true;
      }

      snake.unshift(head);

      // apple eaten?
      if (head.x === apple.x && head.y === apple.y) {
        score += 1;
        if (score > best) { best = score; localStorage.setItem('snake-best', best); }
        document.getElementById('score').textContent = score;
        document.getElementById('best').textContent = best;
        apple = spawnApple();
        if (speedMs > 60) speedMs -= 2; // slight acceleration
      } else {
        snake.pop();
      }
      return true;
    }

    function render() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0, canvas.width, canvas.height);

      // draw apple
      drawCell(apple.x, apple.y, '#ff4d4d');

      // draw snake
      snake.forEach((seg, i) => drawCell(seg.x, seg.y, i===0 ? '#9df2b9' : '#2bdc75'));
    }

    function reset() {
      snake = [{x: 9, y: 9}];
      dir = {x: 1, y: 0};
      pendingDir = dir;
      apple = spawnApple();
      score = 0;
      speedMs = 120;
      document.getElementById('score').textContent = score;
    }

    // Keyboard controls
    window.addEventListener('keydown', (e) => {
      const k = e.key;
      if (k === 'ArrowUp' && dir.y !== 1) pendingDir = {x:0, y:-1};
      else if (k === 'ArrowDown' && dir.y !== -1) pendingDir = {x:0, y:1};
      else if (k === 'ArrowLeft' && dir.x !== 1) pendingDir = {x:-1, y:0};
      else if (k === 'ArrowRight' && dir.x !== -1) pendingDir = {x:1, y:0};
    });

    // On-screen buttons
    const up = document.getElementById('up');
    const down = document.getElementById('down');
    const left = document.getElementById('left');
    const right = document.getElementById('right');
    up.onclick = () => { if (dir.y !== 1) pendingDir = {x:0,y:-1}; };
    down.onclick = () => { if (dir.y !== -1) pendingDir = {x:0,y:1}; };
    left.onclick = () => { if (dir.x !== 1) pendingDir = {x:-1,y:0}; };
    right.onclick = () => { if (dir.x !== -1) pendingDir = {x:1,y:0}; };

    // Basic swipe controls for touch
    let sx=0, sy=0;
    canvas.addEventListener('touchstart', (e)=>{
      const t = e.changedTouches[0]; sx = t.clientX; sy = t.clientY;
    }, {passive:true});
    canvas.addEventListener('touchend', (e)=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - sx;
      const dy = t.clientY - sy;
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 10 && dir.x !== -1) pendingDir = {x:1,y:0};
        else if (dx < -10 && dir.x !== 1) pendingDir = {x:-1,y:0};
      } else {
        if (dy > 10 && dir.y !== -1) pendingDir = {x:0,y:1};
        else if (dy < -10 && dir.y !== 1) pendingDir = {x:0,y:-1};
      }
    }, {passive:true});

    requestAnimationFrame(loop);
  </script>
</body>
</html>
